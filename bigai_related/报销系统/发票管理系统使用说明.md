# 发票管理系统使用说明

本系统提供了一套完整的发票管理解决方案，包括发票号码查询、已报销发票检查和重复文件清理功能。

## 📁 系统结构

```
/Users/lr-2002/Documents/报销材料/
├── tbd/                    # 待处理发票文件夹
│   ├── done/               # 已报销发票（自动生成）
│   └── duplicates/         # 重复文件备份（自动生成）
├── 6.27/发票/              # 已报销发票
├── 7.18/发票/              # 已报销发票
├── 8.25/发票/              # 已报销发票
├── 9.15/发票/              # 已报销发票
├── 9.26/发票/              # 已报销发票
├── cnc报销/                # 已报销发票
└── iros2025/               # 已报销发票
```

## 🛠️ 系统组件

### 1. 发票号码查询工具 (`invoice_number_checker.py`)
查询发票号码是否已报销，支持多种查询方式。

### 2. 已报销发票检查工具 (`check_reimbursed_invoices.py`)
检查tbd文件夹中的发票是否已经报销过，自动移动已报销的发票。

### 3. 重复文件清理工具 (`deduplicate_tbd.py`)
检测并清理tbd文件夹中的重复文件。

---

## 📋 详细使用指南

### 🔍 1. 发票号码查询

#### 基本查询（默认只查已报销的发票）
```bash
python invoice_number_checker.py "25952000000153650524"
```
**输出示例：**
```
=== 发票号码查询结果 ===
发票号码: 25952000000153650524
是否已报销: 是
查询范围: 仅已报销发票
出现次数: 2
相关文件:
  - /Users/lr-2002/Documents/报销材料/7.18/dzfp_25952000000153650524_北京通用人工智能研究院_20250728143524.pdf
  - /Users/lr-2002/Documents/报销材料/7.18/发票/达妙调试.pdf
```

#### 包含待处理发票的查询
```bash
python invoice_number_checker.py "25952000000153650524" --include-tbd
```

#### 查询PDF文件
```bash
python invoice_number_checker.py "/path/to/invoice.pdf" --type file
```

#### 查询文件夹
```bash
# 查询普通文件夹
python invoice_number_checker.py "/Users/lr-2002/Documents/报销材料/7.18/发票/" --type folder

# 查询tbd文件夹
python invoice_number_checker.py "/Users/lr-2002/Documents/报销材料/tbd/" --type folder --include-excluded
```

#### 显示统计信息
```bash
python invoice_number_checker.py "test" --stats
```

#### 导出所有发票号码
```bash
python invoice_number_checker.py "test" --export "invoice_numbers.txt"
```

---

### 🔄 2. 已报销发票检查与整理

#### 演练模式（推荐先运行）
```bash
python check_reimbursed_invoices.py --dry-run
```
**功能：** 检查tbd文件夹中的发票是否已报销，但不实际移动文件。

#### 正式执行
```bash
python check_reimbursed_invoices.py
```
**功能：**
- 检查tbd文件夹中所有PDF的发票号码
- 与已报销文件夹中的发票号码对比
- 将已报销的发票移动到 `tbd/done/` 文件夹
- 为每个移动的文件创建信息记录

#### 强制刷新缓存
```bash
python check_reimbursed_invoices.py --refresh-cache
```

**输出示例：**
```
==================================================
📊 处理结果报告
==================================================
📁 总文件数: 65
✅ 已报销文件数: 26
⏳ 未报销文件数: 39
📦 已移动文件数: 26

📋 已移动的文件:
  1. 41.3 轴承.pdf
     发票号码: 25342000000152860472
  2. 开发版.pdf
     发票号码: 25952000000184500928
  ...
```

---

### 🧹 3. 重复文件清理

#### 检查重复文件（演练模式）
```bash
python deduplicate_tbd.py --dry-run
```
**功能：** 只检查并报告重复文件，不执行移动操作。

#### 执行去重操作
```bash
python deduplicate_tbd.py
```
**执行步骤：**
1. 检查tbd文件夹中所有PDF文件
2. 计算每个文件的MD5哈希值
3. 提取发票号码进行分组
4. 识别完全相同的文件
5. 保留修改时间最新的文件
6. 移动重复文件到 `tbd/duplicates/` 文件夹

**输出示例：**
```
============================================================
🔍 TBD文件夹重复文件检查报告
============================================================
📊 文件统计:
  总文件数: 39
  包含发票号码的文件: 39
  发票号码重复组数: 11
  完全相同的文件组数: 11

📋 发票号码重复详情:
  1. 发票号码: 25132000000155722017
     重复文件数: 2
     1. 16 轴承.pdf (最新)
     2. 轴承6.pdf
```

---

## 🚀 推荐工作流程

### 场景1：新的发票处理
1. **添加发票** → 将新的PDF发票放入 `tbd/` 文件夹
2. **检查重复** → 运行去重工具
   ```bash
   python deduplicate_tbd.py --dry-run  # 先检查
   python deduplicate_tbd.py            # 确认后执行
   ```
3. **检查已报销** → 检查是否已报销过
   ```bash
   python check_reimbursed_invoices.py --dry-run  # 先检查
   python check_reimbursed_invoices.py            # 确认后执行
   ```
4. **开始报销** → 处理 `tbd/` 文件夹中剩余的发票

### 场景2：查询发票状态
```bash
# 查询特定发票是否已报销
python invoice_number_checker.py "发票号码"

# 查看tbd文件夹中有哪些待处理发票
python invoice_number_checker.py "/Users/lr-2002/Documents/报销材料/tbd/" --type folder --include-excluded
```

### 场景3：定期维护
```bash
# 1. 更新缓存
python invoice_number_checker.py "test" --refresh

# 2. 清理重复文件
python deduplicate_tbd.py --dry-run
python deduplicate_tbd.py

# 3. 检查新报销的发票
python check_reimbursed_invoices.py --dry-run
python check_reimbursed_invoices.py

# 4. 查看统计信息
python invoice_number_checker.py "test" --stats
```

---

## ⚠️ 注意事项

### 安全性
- ✅ 所有操作都有 **演练模式**（`--dry-run`）
- ✅ 重复文件被 **移动** 而非删除，保存在 `duplicates/` 文件夹
- ✅ 已报销文件移动到 `done/` 文件夹，便于追溯
- ✅ 自动生成操作记录和日志

### 性能优化
- 🔄 首次运行会扫描所有PDF文件并缓存发票号码
- ⚡ 后续查询使用缓存，速度极快
- 💾 使用 `--refresh` 参数强制更新缓存

### 文件要求
- 📄 支持 PDF 格式的发票文件
- 🔤 支持 中文发票（使用 chi_sim OCR）
- 📋 发票号码通常为8位以上的数字

### 系统依赖
确保已安装以下依赖：
```bash
pip install pandas openpyxl PyMuPDF pytesseract Pillow pathlib2
```

系统依赖：
- Tesseract OCR（用于中文识别）
  ```bash
  # macOS
  brew install tesseract tesseract-lang

  # Ubuntu/Debian
  sudo apt-get install tesseract-ocr tesseract-ocr-chi-sim
  ```

---

## 🆘 故障排除

### 常见问题

1. **OCR识别率低**
   - 检查PDF文件质量
   - 确保Tesseract正确安装并配置中文语言包

2. **发票号码识别错误**
   - 手动验证识别结果
   - 检查发票格式是否标准

3. **缓存问题**
   ```bash
   # 强制刷新缓存
   python invoice_number_checker.py "test" --refresh
   ```

4. **文件权限问题**
   - 确保对报销材料文件夹有读写权限
   - 检查文件是否被其他程序占用

### 日志查看
所有操作都会生成详细日志，可在终端查看实时处理进度。

---

## 📞 技术支持

如遇到问题：
1. 首先尝试使用 `--dry-run` 模式
2. 查看终端输出的错误信息
3. 检查文件格式和路径是否正确
4. 确认依赖包是否正确安装

---

**🎯 核心价值：** 通过自动化工具，避免重复报销，提高发票处理效率，确保报销流程的准确性和完整性。